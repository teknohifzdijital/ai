ş<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akşemseddin AI | Sohbet Arayüzü</title>
    <!-- Tailwind CSS Yüklemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font Yüklemesi -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#1e293b', // Slate-800
                        'accent-teal': '#2dd4bf', // Teal-400
                        'light-bg': '#f8fafc', // Slate-50
                        'user-bubble': '#0f766e', // Teal-700
                        'ai-bubble': '#f1f5f9', // Slate-100
                    }
                }
            }
        }
    </script>
    <style>
        /* Modern ve temiz görünüm için temel stil ayarlamaları */
        body {
            background-color: #e2e8f0; /* Açık Mavi-Gri Arka Plan */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }
        .main-card {
            max-width: 900px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        #chatWindow {
            /* Sohbet penceresi için sabit yükseklik ve kaydırma */
            height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .user-message {
            margin-left: auto;
            background-color: var(--tw-colors-user-bubble);
            color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
        }
        .ai-message {
            margin-right: auto;
            background-color: var(--tw-colors-ai-bubble);
            color: #1e293b;
            border-radius: 1rem 1rem 1rem 0.25rem;
        }
    </style>
</head>
<body class="font-sans">

    <div id="app" class="main-card bg-white rounded-xl p-8 md:p-12 mt-10">
        <!-- Başlık Bölümü -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-primary-dark tracking-tight">
                Akşemseddin <span class="text-accent-teal">AI</span>
            </h1>
            <p class="mt-2 text-lg text-gray-500">Bilim, maneviyat ve rehberlik için minimalist asistanınız.</p>
        </header>
        
        <!-- Kontrol Butonları -->
        <div class="flex justify-end items-center mb-6">
            <!-- Firebase kaldırıldığı için kullanıcı kimliği gösterimi kaldırıldı. -->
             <button id="newChatButton"
                    class="flex items-center px-4 py-2 text-sm font-medium rounded-lg text-primary-dark bg-gray-100 hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-teal">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.181a6.825 6.825 0 008.648-2.585l-1.332-2.529a6.825 6.825 0 00-.776-1.554l-.497-.94a7.5 7.5 0 014.246-3.238l-1.33-2.527a8 8 0 00-11.905 10.901l3.18 3.181z" />
                </svg>
                Yeni Sohbet Başlat
            </button>
        </div>

        <!-- Sohbet Penceresi (Geçmiş ve Cevaplar) -->
        <div id="chatWindow" class="space-y-6 p-4 border border-gray-200 rounded-xl bg-light-bg mb-6">
            <!-- Mesajlar buraya yüklenecek -->
            <div id="initialMessage" class="text-center text-gray-500 italic pt-16">
                Sohbeti başlatmak için bir soru sorun.
            </div>
        </div>
        
        <!-- Giriş Formu -->
        <div class="space-y-4">
            <div id="errorDisplay" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm" role="alert">
                Bir hata oluştu. Lütfen tekrar deneyin.
            </div>
            
            <textarea id="promptInput" rows="3" placeholder="Ne sormak istersiniz? (Örnek: Başarıya ulaşmanın 3 temel adımı nedir?)"
                      class="w-full p-4 border border-gray-300 rounded-lg focus:ring-accent-teal focus:border-accent-teal transition duration-150 ease-in-out resize-none text-gray-700 placeholder-gray-400">
            </textarea>

            <button id="generateButton"
                    class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-primary-dark hover:bg-gray-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-accent-teal/50 disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="buttonText">Sorgula ve Cevap Al</span>
                <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>

    </div>

    <script type="module">
        // --- Uygulama Sabitleri ve Değişkenleri ---
        const STORAGE_KEY = 'akşemseddin_chat_history'; // localStorage için anahtar
        let currentMessages = []; // Sohbet geçmişini tutan array

        // API Anahtarı ve Model Ayarları
        const API_KEY = "sk-ijklmnopabcd5678ijklmnopabcd5678ijklmnop"; // GÜNCELLENEN ANAHTAR
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

        // UI Elementleri
        const promptInput = document.getElementById('promptInput');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const chatWindow = document.getElementById('chatWindow');
        const errorDisplay = document.getElementById('errorDisplay');
        const newChatButton = document.getElementById('newChatButton');

        // Sabit Sistem Talimatı: Akşemseddin'in bilge ve yol gösterici kişiliğini yansıtır
        const SYSTEM_INSTRUCTION = "Akşemseddin'in ruhuyla hareket eden, bilge, yol gösterici ve sade bir tona sahip bir danışman gibi davran. Cevapların kısa, derin ve ilham verici olsun.";

        // --- LocalStorage ve Sohbet Yönetimi ---

        /**
         * Mesajları localStorage'dan yükler ve arayüzü günceller.
         */
        function loadMessagesFromLocalStorage() {
            try {
                const storedHistory = localStorage.getItem(STORAGE_KEY);
                if (storedHistory) {
                    currentMessages = JSON.parse(storedHistory);
                } else {
                    currentMessages = [];
                }
                renderMessages();
            } catch (error) {
                console.error("Local Storage'dan yüklenirken hata:", error);
                displayError("Sohbet geçmişi yüklenemedi. Tarayıcı ayarlarınızı kontrol edin.");
            }
        }

        /**
         * Yeni mesajı ve güncel geçmişi localStorage'a kaydeder.
         * @param {string} role 'user' veya 'model'
         * @param {string} text Mesaj içeriği
         */
        function saveMessageToLocalStorage(role, text) {
            currentMessages.push({
                role: role,
                text: text,
                timestamp: new Date().toISOString()
            });

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentMessages));
                renderMessages();
            } catch (error) {
                console.error("Local Storage'a kaydederken hata:", error);
                displayError("Mesajınız kaydedilemedi (Tarayıcı Depolama Hatası).");
            }
        }
        
        /**
         * Tüm sohbet geçmişini localStorage'dan temizler (Yeni Sohbet).
         */
        function startNewChat() {
            setLoadingState(true, "Sohbet Geçmişi Temizleniyor...");
            
            // LocalStorage'ı ve bellek içi geçmişi temizle
            localStorage.removeItem(STORAGE_KEY);
            currentMessages = [];
            
            renderMessages(); // Arayüzü hemen temizle
            setLoadingState(false, "Sorgula ve Cevap Al");
            chatWindow.scrollTo(0, 0); // Pencereyi yukarı kaydır
        }

        // --- Arayüz Güncelleme ve Hata Yönetimi ---

        /**
         * Mesaj listesini arayüze çizer.
         */
        function renderMessages() {
            chatWindow.innerHTML = ''; // İçeriği temizle

            if (currentMessages.length === 0) {
                chatWindow.innerHTML = `<div id="initialMessage" class="text-center text-gray-500 italic pt-16">
                    Sohbeti başlatmak için bir soru sorun.
                </div>`;
                return;
            }

            currentMessages.forEach(message => {
                const isUser = message.role === 'user';
                const messageDiv = document.createElement('div');
                
                // Mesaj baloncuğu stilleri
                messageDiv.className = `flex max-w-[85%] p-3 rounded-xl whitespace-pre-wrap ${isUser ? 'user-message ml-auto' : 'ai-message mr-auto'}`;
                
                // Markdown'ı basitçe işle (çoklu satır desteği için)
                messageDiv.textContent = message.text; 
                
                chatWindow.appendChild(messageDiv);
            });
            
            // Otomatik aşağı kaydırma
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        /**
         * Arayüzdeki yüklenme durumunu ayarlar.
         * @param {boolean} isLoading Yükleniyor durumu
         * @param {string} text Buton metni
         */
        function setLoadingState(isLoading, text = 'Sorgula ve Cevap Al') {
            generateButton.disabled = isLoading;
            newChatButton.disabled = isLoading;
            promptInput.disabled = isLoading;
            
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                buttonText.textContent = text;
                errorDisplay.classList.add('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = text;
            }
        }
        
        /**
         * Hata mesajını görüntüler.
         * @param {string} message Görüntülenecek hata mesajı
         */
        function displayError(message) {
            errorDisplay.textContent = message;
            errorDisplay.classList.remove('hidden');
        }

        // --- Gemini API Çağrısı ---
        
        /**
         * Gemini API'ye istek gönderir (Üstel Geri Çekilme (Exponential Backoff) ile).
         * @param {string} userQuery Kullanıcının metin girdisi.
         * @param {number} retryCount Deneme sayısı (varsayılan 0).
         * @returns {Promise<string>} Oluşturulan metin.
         */
        async function generateContent(userQuery, retryCount = 0) {
            // Sohbet geçmişini API'nin beklediği formata dönüştür
            // API'ye gönderilecek geçmişte, henüz kaydetmediğimiz son kullanıcı mesajı hariç tutulur.
            const history = currentMessages.map(msg => ({
                role: msg.role,
                parts: [{ text: msg.text }]
            }));
            
            // Yeni kullanıcı sorgusunu geçmişin sonuna ekle
            const contents = [...history, { role: "user", parts: [{ text: userQuery }] }];

            const payload = {
                contents: contents,
                systemInstruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION }]
                },
            };

            const maxRetries = 5;
            const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000; // 1s, 2s, 4s, ...

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && retryCount < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateContent(userQuery, retryCount + 1);
                }

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`API isteği başarısız oldu: ${response.status}. Detay: ${errorJson.error?.message || 'Bilinmeyen Hata'}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("API'den geçerli metin yanıtı alınamadı veya güvenlik politikaları engelledi.");
                }

                return text;

            } catch (error) {
                console.error("API veya Ağ Hatası:", error);
                throw new Error(error.message || "İstek sırasında bir sorun oluştu.");
            }
        }

        /**
         * Sorgulama işlemini başlatır.
         */
        async function handleGeneration() {
            const userQuery = promptInput.value.trim();

            if (!userQuery) {
                displayError("Lütfen sorgunuzu yazın.");
                return;
            }

            setLoadingState(true);
            const initialQuery = userQuery; // Kullanıcı sorgusunu yakala
            promptInput.value = ''; // Giriş alanını temizle

            try {
                // 1. Kullanıcı mesajını kaydet
                saveMessageToLocalStorage('user', initialQuery);
                
                // 2. Cevabı üret (currentMessages güncel olduğu için doğru geçmişi kullanacak)
                const generatedText = await generateContent(initialQuery);
                
                // 3. Model cevabını kaydet
                saveMessageToLocalStorage('model', generatedText);
                
            } catch (error) {
                displayError(error.message);
            } finally {
                setLoadingState(false);
            }
        }

        // --- Olay Dinleyicileri ---
        generateButton.addEventListener('click', handleGeneration);
        newChatButton.addEventListener('click', startNewChat);

        // Enter tuşuna basıldığında mesaj gönderme
        promptInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleGeneration();
            }
        });

        // Uygulamayı Başlat
        window.onload = loadMessagesFromLocalStorage;

    </script>
</body>
</html>
