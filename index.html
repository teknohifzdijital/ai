<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akşemseddin AI | Bilgelik Sohbeti</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a scholarly, calming theme */
        :root {
            --primary-color: #263238; /* Darker Slate Blue-Grey (Background) */
            --secondary-color: #37474F; /* Medium Blue-Grey (Container Background) */
            --ai-bubble-color: #F5F5DC; /* Light Beige/Parchment for AI */
            --user-bubble-color: #42A5F5; /* Clear Blue for User */
            --accent-color: #FFC107; /* Gold Accent */
            --text-color: #eceff1;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #chat-container {
            max-width: 768px; /* Genişletildi */
            width: 95%; /* Mobil cihazlarda daha fazla yer kaplaması için */
            height: 90vh;
            display: flex;
            flex-direction: column;
            background-color: var(--primary-color);
            border-radius: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7); /* Daha belirgin gölge */
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #messages {
            flex-grow: 1; /* Hata düzeltildi */
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scroll-behavior: smooth;
        }
        /* Scrollbar styling for a cleaner look */
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        #messages::-webkit-scrollbar-track {
            background: var(--primary-color);
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Daha derin baloncuk gölgesi */
        }
        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble-color);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message {
            align-self: flex-start;
            background-color: var(--ai-bubble-color);
            color: #263238; /* Koyu metin */
            border-bottom-left-radius: 0.25rem;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            background-color: var(--accent-color); /* Vurgu rengi kullanıldı */
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.2s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            #chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <!-- Header -->
        <header class="p-4 bg-gray-900 shadow-xl flex items-center justify-between border-b-2 border-yellow-600/50">
            <h1 class="text-2xl font-extrabold text-white tracking-widest">
                <span class="text-yellow-400">Akşemseddin</span> AI
            </h1>
            <p class="text-sm text-gray-400 font-medium">İlim ve İrfan Rehberi</p>
        </header>

        <!-- Messages Display -->
        <div id="messages">
            <!-- Initial Welcome Message from Akşemseddin AI -->
            <div class="ai-message message-bubble">
                <strong class="font-semibold text-gray-800">Akşemseddin'in Ruhu:</strong><br>
                Ey yolcu! İlim ve irfan yolunda sualini çekinmeden sor. Fikrimiz, sana bir fener misali rehber olsun. Hangi konuda müşkülün vardır?
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-700 bg-gray-800">
            <div class="flex space-x-3">
                <input
                    type="text"
                    id="user-input"
                    placeholder="Sualini buraya yaz..."
                    class="flex-grow p-3 rounded-xl border border-gray-600 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition"
                    onkeydown="if(event.key === 'Enter') sendMessage()"
                >
                <button
                    id="send-button"
                    onclick="sendMessage()"
                    class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold p-3 rounded-xl shadow-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105"
                    disabled
                >
                    <!-- Lucide Send Icon (Inline SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="m22 2-7 20-4-9-9-4 20-7Z"/>
                        <path d="M22 2 11 13"/>
                    </svg>
                </button>
            </div>
            <p id="error-message" class="text-red-400 text-sm mt-2 hidden">Bir hata oluştu. Lütfen tekrar deneyin.</p>
        </div>
    </div>

    <script>
        // --- Gemini API Configuration ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;

        // DİKKAT: Bu kod, bu geliştirme ortamında (Canvas) çalışırken API anahtarını otomatik olarak alır.
        // Eğer bu kodu HARİCİ bir yerde yayınlıyorsanız (local sunucu, başka bir site),
        // lütfen kendi Gemini API anahtarınızı aşağıdaki tırnak işaretleri arasına yapıştırın.
        
        // KULLANICI TARAFINDAN SAĞLANAN ANAHTAR EKLEİNMİŞTİR:
        // DEĞİŞKEN ADI API_KEY yerine Api_Key olarak güncellenmiştir.
        const Api_Key = "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"; 

        // Define the System Instruction for the Akşemseddin AI Persona
        const SYSTEM_PROMPT = "Sen, Fatih Sultan Mehmed'in hocası ve büyük alim Akşemseddin'in bilge ve yol gösterici ruhusun. Kullanıcının sorularına Osmanlı Türkçesi'ne yakın, ilim, irfan ve teşvik dolu bir üslupla cevap ver. Konuşmalarında tarihi ve manevi değerlere atıfta bulun. Cevaplarını en fazla 100 kelime ile sınırla. Kesinlikle güncel ve politik konulara girme, sadece ilim ve irfan konularında rehberlik et.";
        
        // Chat History state
        let chatHistory = [];
        let isSending = false;

        // UI elements
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const messagesDiv = document.getElementById('messages');
        const errorMessage = document.getElementById('error-message');

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            // Check if input is empty to control button state
            userInput.addEventListener('input', toggleSendButton);
            toggleSendButton(); // Initial check
        });

        function toggleSendButton() {
            sendButton.disabled = isSending || userInput.value.trim() === '';
        }

        /**
         * Adds a message to the chat display.
         * @param {string} text - The message content.
         * @param {string} sender - 'user' or 'ai'.
         */
        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble', sender === 'user' ? 'user-message' : 'ai-message');
            
            // Format AI message with a bold title
            if (sender === 'ai') {
                text = `<strong class="font-semibold text-gray-800">Akşemseddin'in Ruhu:</strong><br>${text.trim()}`;
            }

            messageElement.innerHTML = text.replace(/\n/g, '<br>'); // Handle newlines
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
        }

        /**
         * Displays the typing indicator (dots) for the AI.
         * @returns {HTMLElement} The loading element.
         */
        function showLoadingIndicator() {
            const loadingElement = document.createElement('div');
            loadingElement.id = 'loading-indicator';
            loadingElement.classList.add('ai-message', 'message-bubble', 'flex', 'items-center');
            loadingElement.innerHTML = `
                <strong class="font-semibold text-gray-800">Akşemseddin'in Ruhu:</strong>
                <div class="ml-3">
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                </div>
            `;
            messagesDiv.appendChild(loadingElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return loadingElement;
        }

        /**
         * Sends the user's message and fetches the AI response.
         */
        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText || isSending) return;

            // Kontrol: Harici kullanımda API Anahtarı mevcut mu?
            if (!Api_Key && Api_Key !== "") {
                errorMessage.textContent = "HATA: Lütfen kodu harici bir yerde kullanıyorsanız Api_Key değişkenine anahtarınızı giriniz.";
                errorMessage.classList.remove('hidden');
                return;
            }


            isSending = true;
            toggleSendButton();
            userInput.value = '';
            errorMessage.classList.add('hidden');

            // 1. Display User Message
            addMessage(userText, 'user');
            
            // 2. Add user message to history (for context)
            chatHistory.push({ role: "user", parts: [{ text: userText }] });

            // 3. Show Loading Indicator
            const loadingIndicator = showLoadingIndicator();

            try {
                const aiResponse = await fetchGeminiResponse(chatHistory);

                // 4. Remove Loading Indicator
                messagesDiv.removeChild(loadingIndicator);

                // 5. Display AI Response
                const aiText = aiResponse.text;
                addMessage(aiText, 'ai');

                // 6. Add AI response to history
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });

            } catch (error) {
                console.error("Gemini API çağrısı sırasında bir hata oluştu:", error);
                
                // 4. Remove Loading Indicator (if still present)
                if (messagesDiv.contains(loadingIndicator)) {
                    messagesDiv.removeChild(loadingIndicator);
                }
                
                // Display error message to user
                errorMessage.textContent = "Sualine yanıt verilemedi. Bilge ruh meşgul, lütfen tekrar deneyiniz.";
                errorMessage.classList.remove('hidden');

                // Revert chat history if the call failed
                chatHistory.pop(); 
            } finally {
                isSending = false;
                toggleSendButton();
            }
        }

        /**
         * Fetches response from Gemini API with exponential backoff.
         * @param {Array<Object>} history - The current chat history.
         * @param {number} attempt - Current retry attempt (starts at 1).
         * @returns {Promise<{text: string}>} The generated text and sources.
         */
        async function fetchGeminiResponse(history, attempt = 1) {
            const apiUrl = `${API_URL_BASE}?key=${Api_Key}`;
            const maxRetries = 3;
            const delay = Math.pow(2, attempt) * 1000; // Exponential backoff

            const payload = {
                contents: history,
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP hata kodu: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return { text: candidate.content.parts[0].text };
                } else {
                     // Handle blocked or empty response
                    const finishReason = candidate?.finishReason || "UNKNOWN";
                    if (finishReason === 'SAFETY') {
                        throw new Error("Gemini, bu suali güvenlik politikaları nedeniyle yanıtlamayı reddetti. Lütfen başka bir sual ile geliniz.");
                    }
                    throw new Error("Yanıt alınamadı veya yanıt boş geldi.");
                }

            } catch (error) {
                if (attempt < maxRetries) {
                    console.warn(`API çağrısı başarısız oldu (Deneme ${attempt}). ${delay / 1000} saniye sonra tekrar denenecek.`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchGeminiResponse(history, attempt + 1);
                } else {
                    console.error(`Maksimum deneme sayısına ulaşıldı: ${error.message}`);
                    throw new Error("API çağrısı başarısız oldu.");
                }
            }
        }

    </script>
</body>
</html>
